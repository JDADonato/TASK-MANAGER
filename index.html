<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexus Task Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="shortcut icon" href="nexus_logo.png" type="image/x-icon" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");

    :root {
      --primary: #1a1a1a;
      --secondary: #2d2d2d;
      --accent: #00ff88;
      --text: #ffffff;
      --danger: #ff4444;
      --warning: #ffbb33;
    }

    * {
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      background: var(--primary);
      color: var(--text);
      margin: 0;
      padding: 20px;
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 20px;
      min-height: 100vh;
    }

    @media (max-width: 768px) {
      body {
        grid-template-columns: 1fr;
      }
    }

    .priority-badge {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.75em;
      font-weight: bold;
      display: inline-block;
    }

    .priority-High {
      background: var(--danger);
      color: white;
    }

    .priority-Medium {
      background: var(--warning);
      color: black;
    }

    .priority-Low {
      background: #888;
      color: white;
    }

    .fade-out {
      animation: fadeOut 0.6s forwards;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        height: 0;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }
    }

    .color-picker {
      width: 36px;
      height: 36px;
      margin-right: 10px;
      border: 1px solid #666;
      border-radius: 6px;
      padding: 0;
      cursor: pointer;
      background: none;
      appearance: none;
      -webkit-appearance: none;
      transition: border 0.2s ease;
    }

    .color-picker:hover {
      border-color: var(--accent);
    }

    .color-picker::-webkit-color-swatch-wrapper {
      padding: 0;
      border-radius: 6px;
    }

    .color-picker::-webkit-color-swatch {
      border: none;
      border-radius: 6px;
    }

    .main-panel,
    .side-panel {
      background: var(--secondary);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      overflow-x: auto;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      background: var(--accent);
      color: var(--primary);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    .counters {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    td select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-color: #2a2a2a;
      color: inherit;
      padding-right: 24px;
      background-image: none;
      position: relative;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      opacity: 0.001;
      /* practically invisible */
      cursor: pointer;
      width: 100%;
      height: 100%;
      position: absolute;
      right: 0;
    }

    input[type="date"] {
      position: relative;
      /* text-align: center; */
      background: #2a2a2a;
      color: var(--text);
      border: 1px solid #444;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 0.9em;
    }

    td select::-ms-expand {
      display: none;
    }

    td select,
    td input[type="date"] {
      text-align: center;
      text-align-last: center;
      /* For Firefox */
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    td.details {
      text-align: left;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 250px;
      white-space: normal;
    }

    td select,
    td input[type="date"] {
      background: #2a2a2a;
      color: var(--text);
      border: 1px solid #444;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.9em;
      width: 100%;
      box-shadow: none;
      outline: none;
    }

    td select:hover,
    td input[type="date"]:hover {
      border-color: var(--accent);
    }

    tr {
      background: rgba(255, 255, 255, 0.02);
      transition: background 0.2s;
      cursor: pointer;
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .status-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    #taskModal button {
      margin-top: 10px;
      font-weight: bold;
      border-radius: 8px;
    }

    #taskModal .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    #taskModal #modalTitle {
      margin-top: 0;
      margin-bottom: 20px;
      /* adjust as needed */
      font-size: 1.4em;
    }

    #taskModal .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 18px;
    }

    #taskModal .form-group label {
      font-size: 0.95em;
      color: #ccc;
    }

    #taskModal input,
    #taskModal select,
    #taskModal textarea {
      padding: 10px;
      font-size: 0.95em;
      border-radius: 8px;
    }

    #taskModal textarea {
      min-height: 80px;
      resize: vertical;
    }

    .color-picker {
      width: 36px;
      height: 36px;
      border: 1px solid #555;
      border-radius: 6px;
      background-color: transparent;
      padding: 0;
      margin-right: 10px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      transition: border 0.2s ease;
    }

    .color-picker:hover {
      border-color: var(--accent);
    }

    .color-picker::-webkit-color-swatch-wrapper {
      padding: 0;
      border-radius: 6px;
    }

    .color-picker::-webkit-color-swatch {
      border: none;
      border-radius: 6px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(40, 40, 40, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      width: 360px;
      max-width: 90%;
      z-index: 1000;
      padding: 25px 30px;
      border-radius: 20px;
      width: 400px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 5px;
      background: #333;
      color: white;
      border: none;
      border-radius: 6px;
      resize: none;
    }

    .subject-item,
    .type-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 6px 10px;
      background: #2a2a2a;
      border-radius: 6px;
    }

    .subject-item button,
    .type-item button {
      background: var(--danger);
      border: none;
      padding: 6px;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    #calendarModal .modal {
      width: 90vw;
      max-width: 800px;
      overflow-y: auto;
      max-height: 90vh;
    }

    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 15px 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      min-width: 300px;
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      background: #333;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .calendar-date {
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .task-dots {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      justify-content: center;
    }

    .task-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .task-dot:hover {
      transform: scale(1.2);
    }

    .calendar-day.other-month {
      background: #2a2a2a;
      opacity: 0.5;
    }

    tr.highlight {
      background: var(--accent) !important;
      box-shadow: 0 0 12px 4px rgba(0, 255, 136, 0.6);
      transition: all 0.4s ease;
      border-radius: 10px;
    }

    @keyframes pulseHighlight {
      0% {
        box-shadow: 0 0 0 rgba(0, 255, 136, 0.6);
      }

      50% {
        box-shadow: 0 0 20px 8px rgba(0, 255, 136, 0.4);
      }

      100% {
        box-shadow: 0 0 0 rgba(0, 255, 136, 0);
      }
    }

    tr.highlight {
      animation: pulseHighlight 1s ease-in-out;
    }

    html {
      scroll-behavior: smooth;
    }

    .side-task-card {
      background: #1f1f1f;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 5px solid var(--accent);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .side-task-card .task-title {
      font-weight: bold;
      color: var(--text);
      margin-bottom: 4px;
    }

    .side-task-card .task-date {
      font-size: 0.85em;
      color: #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .side-task-card .due-in {
      color: var(--accent);
    }

    .side-task-card.today-highlight {
      border: 2px solid var(--danger);
      background: #2a1a1a;
    }

    .side-task-card .today-alert {
      color: var(--danger);
      font-weight: bold;
    }

    .side-task-card {
      transition: all 0.3s ease;
    }

    .side-task-card:hover {
      background: #2e2e2e;
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 8px 16px rgba(0, 255, 136, 0.3);
      border-left: 6px solid var(--accent);
    }

    .button {
      background: var(--accent);
      color: var(--primary);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--secondary);
      border: 1px solid #444;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      min-width: 160px;
      padding: 10px 0;
    }

    .dropdown-content .dropdown-btn {
      background: none;
      color: var(--text);
      border: none;
      padding: 10px 20px;
      text-align: left;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .dropdown-content .dropdown-btn:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .styled-select {
      position: relative;
      display: inline-block;
      width: 180px;
    }

    .styled-select select {
      width: 100%;
      padding: 10px;
      padding-right: 30px;
      border-radius: 6px;
      background-color: var(--accent);
      color: var(--primary);
      border: none;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .styled-select i {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--primary);
    }
  </style>
</head>

<body>
  <div class="main-panel">
    <div class="controls">
      <button onclick="showModal('task')">New Task</button>
      <div class="dropdown" style="position: relative;">
        <button onclick="toggleDropdown()" class="button">
          Manage <i class="fa fa-caret-down"></i>
        </button>
        <div id="manageDropdown" class="dropdown-content">
          <button onclick="showModal('subject')" class="dropdown-btn">Subjects</button>
          <button onclick="showModal('type')" class="dropdown-btn">Types</button>
          <button onclick="exportTasks()" class="dropdown-btn">Export</button>
          <label class="dropdown-btn" style="margin: 0; display: block; cursor: pointer;">
            Import
            <input type="file" accept=".json" onchange="importTasks(event)" style="display: none;" />
          </label>
        </div>
      </div>
      <button onclick="showModal('calendar')">Calendar View</button>
      <button onclick="renderTasks()">Sort by Due Date</button>


      <input id="taskSearch" type="text" placeholder="Search..." oninput="filterTasks()"
        style="padding: 10px; border-radius: 6px; flex: 1; max-width: 300px" />
      <div class="styled-select">
        <select id="priorityFilter" onchange="filterTasks()">
          <option value="">All Priorities</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
        <i class="fa fa-caret-down"></i>
      </div>
    </div>
    <div class="counters">
      <div>Total: <span id="totalCounter">0</span></div>
      <div>Completed: <span id="completedCounter">0</span></div>
      <div>Pending: <span id="pendingCounter">0</span></div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Due Date</th>
          <th>Type</th>
          <th>Details</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="taskBody"></tbody>
    </table>
  </div>
  <div class="side-panel">
    <h3>Upcoming</h3>
    <div id="upcomingTasks"></div>
    <h3>Urgent</h3>
    <div id="urgentTasks"></div>
  </div>
  <div class="modal-overlay" id="modalOverlay" onclick="hideModals()"></div>
  <div id="taskModal" class="modal">
    <h2 id="modalTitle">New Task</h2>
    <div class="form-group">
      <label>Subject:</label><select id="taskSubject"></select>
    </div>
    <div class="form-group">
      <label>Due Date:</label><input type="date" id="taskDueDate" />
    </div>
    <div class="form-group">
      <label>Type:</label><select id="taskType"></select>
    </div>
    <div class="form-group">
      <label>Priority:</label>
      <select id="taskPriority">
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
    </div>

    <div class="form-group">
      <label>Details:</label><textarea id="taskDetails"></textarea>
    </div>
    <input type="hidden" id="taskId" />
    <button onclick="saveTask()">Save</button>
  </div>
  <div id="subjectModal" class="modal">
    <h2>Manage Subjects</h2>
    <div id="subjectsList"></div>
    <div class="form-group">
      <input type="text" id="newSubject" placeholder="New subject" />
      <input type="color" id="subjectColor" style="height: 50px; cursor: pointer; margin: 10px 0 10px" />
      <button onclick="addSubject()">Add</button>
    </div>
  </div>
  <div id="typeModal" class="modal">
    <h2>Manage Types</h2>
    <div id="typesList"></div>
    <div class="form-group">
      <input type="text" id="newType" placeholder="New type" />
      <input type="color" id="typeColor" style="height: 50px; cursor: pointer; margin: 10px 0 10px" />
      <button onclick="addType()">Add</button>
    </div>
  </div>
  <div id="calendarModal" class="modal">
    <h2>Calendar View</h2>
    <div class="calendar-controls">
      <button onclick="changeMonth(-1)">&lt;</button>
      <h3 id="currentMonth"></h3>
      <button onclick="changeMonth(1)">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
  <div class="toast" id="toast"></div>
  <div class="toast" id="undoToast" style="background: #222"></div>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>

    function toggleDropdown() {
      const dropdown = document.getElementById("manageDropdown");
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      // Close when clicking outside
      window.addEventListener("click", function closeOutside(e) {
        if (!dropdown.contains(e.target) && !e.target.closest("button[onclick='toggleDropdown()']")) {
          dropdown.style.display = "none";
          window.removeEventListener("click", closeOutside);
        }
      });
    }

    let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
    let subjects = JSON.parse(localStorage.getItem("subjects")) || [];
    let types = JSON.parse(localStorage.getItem("types")) || [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function showModal(type) {
      document.getElementById("modalOverlay").style.display = "block";
      document.getElementById(`${type}Modal`).style.display = "block";
      if (type === "task") {
        populateDropdown("taskSubject", subjects);
        populateDropdown("taskType", types);
      }
      if (type === "calendar") generateCalendar(currentMonth, currentYear);
    }

    function hideModals() {
      document
        .querySelectorAll(".modal")
        .forEach((m) => (m.style.display = "none"));
      document.getElementById("modalOverlay").style.display = "none";
      document.getElementById("taskId").value = "";
    }

    function populateDropdown(id, list) {
      const select = document.getElementById(id);
      select.innerHTML = list
        .map((i) => `<option value="${i.name}">${i.name}</option>`)
        .join("");
    }

    function addSubject() {
      const name = document.getElementById("newSubject").value.trim();
      const color = document.getElementById("subjectColor").value;
      if (!name) return showToast("Subject required");
      if (subjects.some((s) => s.name.toLowerCase() === name.toLowerCase()))
        return showToast("Duplicate subject");
      subjects.push({ name, color });
      localStorage.setItem("subjects", JSON.stringify(subjects));
      renderSubjects();
      populateDropdown("taskSubject", subjects);
      document.getElementById("newSubject").value = "";
    }

    function addType() {
      const name = document.getElementById("newType").value.trim();
      const color = document.getElementById("typeColor").value;
      if (!name) return showToast("Type required");
      if (types.some((t) => t.name.toLowerCase() === name.toLowerCase()))
        return showToast("Duplicate type");
      types.push({ name, color });
      localStorage.setItem("types", JSON.stringify(types));
      renderTypes();
      populateDropdown("taskType", types);
      document.getElementById("newType").value = "";
    }

    function deleteSubject(name) {
      subjects = subjects.filter((s) => s.name !== name);
      localStorage.setItem("subjects", JSON.stringify(subjects));
      renderSubjects();
      populateDropdown("taskSubject", subjects);
      renderTasks();
      updateCounters();
    }

    function deleteType(name) {
      types = types.filter((t) => t.name !== name);
      localStorage.setItem("types", JSON.stringify(types));
      renderTypes();
      populateDropdown("taskType", types);
      renderTasks();
      updateCounters();
    }

    function updateSubjectName(index, newName) {
      const oldName = subjects[index].name;
      if (!newName.trim()) return;
      subjects[index].name = newName.trim();
      tasks.forEach((t) => {
        if (t.subject === oldName) t.subject = newName.trim();
      });
      localStorage.setItem("subjects", JSON.stringify(subjects));
      localStorage.setItem("tasks", JSON.stringify(tasks));
      renderSubjects();
      populateDropdown("taskSubject", subjects);
      renderTasks();
      updateCounters();
      showToast("Subject updated");
    }
    function updateSubjectColor(index, newColor) {
      subjects[index].color = newColor;
      localStorage.setItem("subjects", JSON.stringify(subjects));
      renderSubjects();
      renderTasks();
      updateCounters();
      showToast("Subject color updated");
    }

    function updateTypeName(index, newName) {
      const oldName = types[index].name;
      if (!newName.trim()) return;
      types[index].name = newName.trim();
      tasks.forEach((t) => {
        if (t.type === oldName) t.type = newName.trim();
      });
      localStorage.setItem("types", JSON.stringify(types));
      localStorage.setItem("tasks", JSON.stringify(tasks));
      renderTypes();
      populateDropdown("taskType", types);
      renderTasks();
      updateCounters();
      showToast("Type updated");
    }
    function updateTypeColor(index, newColor) {
      types[index].color = newColor;
      localStorage.setItem("types", JSON.stringify(types));
      renderTypes();
      renderTasks();
      updateCounters();
      showToast("Type color updated");
    }

    function renderSubjects() {
      document.getElementById("subjectsList").innerHTML = subjects
        .map(
          (s, index) => `
      <div class="subject-item">
        <input type="text" value="${s.name}" onchange="updateSubjectName(${index}, this.value)" style="flex:1; background:transparent; color:${s.color}; border:none; font-weight:bold; font-size:1em" />
        <input type="color" class="color-picker" value="${s.color}" onchange="updateSubjectColor(${index}, this.value)" />
        <button onclick="deleteSubject('${s.name}')">Delete</button>
      </div>`
        )
        .join("");
    }

    function renderTypes() {
      document.getElementById("typesList").innerHTML = types
        .map(
          (t, index) => `
      <div class="type-item">
        <input type="text" value="${t.name}" onchange="updateTypeName(${index}, this.value)" style="flex:1; background:transparent; color:${t.color}; border:none; font-weight:bold; font-size:1em" />
        <input type="color" class="color-picker" value="${t.color}" onchange="updateTypeColor(${index}, this.value)" />
        <button onclick="deleteType('${t.name}')">Delete</button>
      </div>`
        )
        .join("");
    }

    function saveTask() {
      const id = document.getElementById("taskId").value;
      const subject = document.getElementById("taskSubject").value;
      const dueDate = document.getElementById("taskDueDate").value;
      const type = document.getElementById("taskType").value;
      const details = document.getElementById("taskDetails").value;
      const priority = document.getElementById("taskPriority").value;

      if (!subject || !dueDate || !type)
        return showToast("Fill all fields, details are optional");

      const task = {
        id: id ? parseInt(id) : Date.now(),
        subject,
        dueDate,
        type,
        details,
        priority,
        completed: false,
      };

      if (id) {
        const i = tasks.findIndex((t) => t.id === parseInt(id));
        if (i !== -1) tasks[i] = task;
      } else {
        tasks.push(task);
      }

      localStorage.setItem("tasks", JSON.stringify(tasks));
      renderTasks();
      updateCounters();
      hideModals();
      showToast(id ? "Task updated" : "Task added");
    }

    function renderTasks({ skipSort = false } = {}) {
      const tbody = document.getElementById("taskBody");
      tbody.innerHTML = "";

      const search = document.getElementById("taskSearch")?.value?.toLowerCase() || "";
      const priority = document.getElementById("priorityFilter")?.value || "";

      let filtered = tasks.filter((t) => {
        return (
          (!search || t.subject.toLowerCase().includes(search) || t.details.toLowerCase().includes(search)) &&
          (!priority || t.priority === priority)
        );
      });

      if (!skipSort) {
        filtered.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      }

      filtered.forEach((task) => {
        const row = document.createElement("tr");
        row.setAttribute("data-id", task.id);
        row.innerHTML = `
          <td>
<select onchange="updateTaskField(${task.id
          }, 'subject', this.value)" style="color: ${getSubjectColor(
            task.subject
          )};">
  ${subjects
            .map(
              (s) =>
                `<option value="${s.name}" ${s.name === task.subject ? "selected" : ""
                }>${s.name}</option>`
            )
            .join("")}
</select>
          </td>
          <td>
            <input type="date" value="${task.dueDate
          }" onchange="updateTaskField(${task.id}, 'dueDate', this.value)">
          </td>
          <td>
<select onchange="updateTaskField(${task.id
          }, 'type', this.value)" style="color: ${getTypeColor(task.type)};">
  ${types
            .map(
              (t) =>
                `<option value="${t.name}" ${t.name === task.type ? "selected" : ""}>${t.name
                }</option>`
            )
            .join("")}
</select>
          </td>
          <td class="details" contenteditable="true" onblur="updateTaskField(${task.id
          }, 'details', this.textContent.trim())">${task.details}</td>
          <td>
            <select onchange="updateTaskField(${task.id
          }, 'priority', this.value)">
              <option value="High" ${task.priority === "High" ? "selected" : ""
          }>High</option>
              <option value="Medium" ${task.priority === "Medium" ? "selected" : ""
          }>Medium</option>
              <option value="Low" ${task.priority === "Low" ? "selected" : ""
          }>Low</option>
            </select>
          </td>
          <td>
            <input type="checkbox" class="status-checkbox" ${task.completed ? "checked" : ""
          } onclick="toggleStatus(${task.id})">
          </td>
          <td>
            <button onclick="deleteTask(${task.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      enableRowDragging();

    }

    function enableRowDragging() {
      const tbody = document.getElementById("taskBody");
      Sortable.create(tbody, {
        animation: 150,
        onEnd: function () {
          const newOrder = [];
          document.querySelectorAll("#taskBody tr").forEach((row) => {
            const id = parseInt(row.getAttribute("data-id"));
            const task = tasks.find((t) => t.id === id);
            if (task) newOrder.push(task);
          });
          tasks = newOrder;
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTasks({ skipSort: true });
          updateCounters();
        },
      });
    }

    function getSubjectColor(name) {
      const subject = subjects.find((s) => s.name === name);
      return subject ? subject.color : "#fff";
    }

    function getTypeColor(name) {
      const type = types.find((t) => t.name === name);
      return type ? type.color : "#fff";
    }

    let deletedTask = null;

    function updateTaskField(id, field, value) {
      const task = tasks.find((t) => t.id === id);
      if (task) {
        task[field] = value;
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
        updateCounters();
        showToast(
          `${field.charAt(0).toUpperCase() + field.slice(1)} updated`
        );
      }
    }
    function deleteTask(id, button) {
      deletedTask = tasks.find((t) => t.id === id);
      tasks = tasks.filter((t) => t.id !== id);
      localStorage.setItem("tasks", JSON.stringify(tasks));
      renderTasks();
      updateCounters();
      showUndo();
    }

    function showUndo() {
      const toast = document.getElementById("undoToast");
      toast.innerHTML = `Task deleted. <button onclick="undoDelete()">Undo</button>`;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
        deletedTask = null;
      }, 4000);
    }

    function undoDelete() {
      if (deletedTask) {
        tasks.push(deletedTask);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
        updateCounters();
        showToast("Task restored");
        deletedTask = null;
      }
    }

    function toggleStatus(id, checkbox) {
      const row = checkbox.closest("tr");
      const task = tasks.find((t) => t.id === id);
      if (task) {
        task.completed = !task.completed;
        row.classList.add("fade-out");
        localStorage.setItem("tasks", JSON.stringify(tasks));
        setTimeout(() => {
          renderTasks();
          updateCounters();
        }, 600);
      }
    }

    function filterTasks() {
      renderTasks();
    }

    function editTask(id) {
      const task = tasks.find((t) => t.id === id);
      if (!task) return;
      showModal("task");
      document.getElementById("taskId").value = task.id;
      document.getElementById("taskSubject").value = task.subject;
      document.getElementById("taskDueDate").value = task.dueDate;
      document.getElementById("taskType").value = task.type;
      document.getElementById("taskDetails").value = task.details;
    }

    function updateCounters() {
      document.getElementById("totalCounter").textContent = tasks.length;
      const completed = tasks.filter((t) => t.completed).length;
      document.getElementById("completedCounter").textContent = completed;
      document.getElementById("pendingCounter").textContent =
        tasks.length - completed;
      renderUrgentAndUpcoming();
    }

    function renderUrgentAndUpcoming() {
      const now = new Date();
      const todayString = now.toDateString();

      function renderTaskCard(task) {
        const dueDate = new Date(task.dueDate);
        const subject = subjects.find((s) => s.name === task.subject);
        const color = subject ? subject.color : "#fff";
        const isToday = dueDate.toDateString() === todayString;
        const daysDiff = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));

        return `
  <div class="side-task-card ${isToday ? "today-highlight" : ""}"
       style="border-left: 6px solid ${color}"
       onclick="highlightTaskById(${task.id})">
    <div class="task-title">${task.subject} - ${task.type}</div>
    <div class="task-date">
      ${formatDateWithoutYear(task.dueDate)} 
      ${isToday
            ? "<span class='today-alert'>❗</span>"
            : `<span class="due-in">${daysDiff} day${daysDiff !== 1 ? "s" : ""} left</span>`}
    </div>
  </div>
`;
      }



      const urgent = tasks.filter(
        (t) => new Date(t.dueDate) < now && !t.completed
      );
      const upcoming = tasks.filter((t) => {
        const diff = (new Date(t.dueDate) - now) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 3 && !t.completed;
      });

      document.getElementById("urgentTasks").innerHTML =
        urgent.map(renderTaskCard).join("") || "<div>No urgent tasks</div>";

      document.getElementById("upcomingTasks").innerHTML =
        upcoming.map(renderTaskCard).join("") ||
        "<div>No upcoming tasks</div>";
    }

    function generateCalendar(month, year) {
      const calendarGrid = document.getElementById("calendarGrid");
      const currentMonthElem = document.getElementById("currentMonth");
      const date = new Date(year, month);

      currentMonthElem.textContent = date.toLocaleString("default", {
        month: "long",
        year: "numeric",
      });

      calendarGrid.innerHTML = "";

      ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].forEach((day) => {
        const dayHeader = document.createElement("div");
        dayHeader.textContent = day;
        dayHeader.style.textAlign = "center";
        dayHeader.style.padding = "8px";
        calendarGrid.appendChild(dayHeader);
      });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      for (let i = 0; i < firstDay.getDay(); i++) {
        createCalendarDay(new Date(year, month, -i), true);
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        createCalendarDay(new Date(year, month, d));
      }

      const nextMonthDays = 7 - (lastDay.getDay() + 1);
      for (let i = 1; i <= nextMonthDays; i++) {
        createCalendarDay(new Date(year, month + 1, i), true);
      }
    }

    function highlightTaskById(id) {
      const row = document.querySelector(`tr[data-id='${id}']`);
      if (row) {
        row.classList.remove("highlight"); // reset if it was already highlighted
        void row.offsetWidth; // force reflow to restart animation
        row.classList.add("highlight");
        row.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => row.classList.remove("highlight"), 1200);
      }
    }

    function createCalendarDay(date, isOtherMonth = false) {
      const dayElement = document.createElement("div");
      dayElement.className = `calendar-day ${isOtherMonth ? "other-month" : ""}`;

      const dayTasks = getTasksForDate(date);

      const dateString = `${date.getFullYear()}-${(date.getMonth() + 1)
        .toString()
        .padStart(2, "0")}-${date.getDate().toString().padStart(2, "0")}`;

      // Build the dots HTML
      const taskDotsHtml = dayTasks.map((task) => {
        const subject = subjects.find((s) => s.name === task.subject);
        const color = subject ? subject.color : "#fff";
        return `<div 
              class="task-dot" 
              style="background: ${color}" 
              onclick="highlightTaskById(${task.id})"
              title="${task.subject} - ${task.type}">
            </div>`;
      }).join("");

      dayElement.innerHTML = `
    <div class="calendar-date">${date.getDate()}</div>
    <div class="task-dots">${taskDotsHtml}</div>
  `;

      dayElement.addEventListener("click", (e) => {
        if (e.target.classList.contains("task-dot")) return;

        const rows = document.querySelectorAll(`#taskBody tr`);
        rows.forEach(row => {
          const dateInput = row.querySelector(`input[type="date"]`);
          if (dateInput && dateInput.value === dateString) {
            row.classList.remove("highlight");
            void row.offsetWidth;
            row.classList.add("highlight");
            row.scrollIntoView({ behavior: "smooth", block: "center" });
            setTimeout(() => row.classList.remove("highlight"), 1200);
          }
        });
      });

      document.getElementById("calendarGrid").appendChild(dayElement);
    }


    function handleCalendarClick(dateString) {
      hideModals();
      const matchedTasks = tasks.filter((task) => {
        const taskDate = new Date(task.dueDate).toISOString().split("T")[0];
        return taskDate === dateString;
      });

      if (matchedTasks.length === 0) {
        showToast("No tasks found for this date");
        return;
      }

      const firstTask = document.querySelector(
        `tr td input[type="date"][value="${dateString}"]`
      );
      if (firstTask) {
        const row = firstTask.closest("tr");
        row.classList.add("highlight");
        row.scrollIntoView({ behavior: "smooth", block: "center" });
        setTimeout(() => row.classList.remove("highlight"), 2000);
      }
    }

    function getTasksForDate(date) {
      return tasks.filter(
        (task) =>
          new Date(task.dueDate).toDateString() === date.toDateString()
      );
    }

    function formatDateWithoutYear(dateString) {
      const options = { month: "long", day: "numeric" };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      } else if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar(currentMonth, currentYear);
    }

    function init() {
      renderSubjects();
      renderTypes();
      renderTasks({ skipSort: true });
      updateCounters();
    }

    function exportTasks() {
      const dataStr = JSON.stringify(tasks, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "tasks.json";
      a.click();
      URL.revokeObjectURL(url);
      showToast("Tasks exported");
    }

    function importTasks(event) {
      const file = event.target.files[0];
      if (!file) return showToast("No file selected");

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedTasks = JSON.parse(e.target.result);
          if (!Array.isArray(importedTasks)) throw new Error("Invalid format");
          tasks = importedTasks;
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTasks();
          updateCounters();
          showToast("Tasks imported");
        } catch (err) {
          showToast("Invalid JSON file");
        }
      };
      reader.readAsText(file);
    }


    init();
  </script>

</body>

</html>
